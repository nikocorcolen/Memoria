
%% inicio, la clase del documento es iccmemoria.cls
\documentclass{iccmemoria}
%% datos generales y para la tapa
\titulo{Smart Irrigation: Prototipo de riego inteligente de bajo costo para el uso eficiente del agua}
\author{Nicolás Gastón Maturana Barrios}
\supervisor{Benjamín Ingram}
\informantes
	{Profesor Informante 1}
	{Profesor Informante 2}
\adicional{(sólo por si se necesita agregar algún otro profesor)}
\director{Profesor del ramo Memoria de Título}
\date{Diciembre, 2015}

%% inicio de documento
\begin{document}
\maketitle

%% dedicatoria
\begin{dedicatory}
Dedicado a ...
\end{dedicatory}

%% agradecimientos
\begin{acknowledgment}
Agradecimientos a ...
\end{acknowledgment}

%% indices
\tableofcontents
\listoffigures
\listoftables

%% resumen
\begin{resumen}

Un riego eficaz sólo es posible con un seguimiento periódico de las condiciones del agua del suelo y con la previsión de las futuras necesidades de agua. Retrasar el riego provoca estrés, o aplicar muy poca agua puede resultar en una pérdida sustancial. La aplicación de mucha agua se traducirá en costos adicionales y agua desperdiciada.

Lo que se busca en este proyecto es aumentar la eficiencia en los recursos hídricos de la zona en la que el dispositivo esté instalado entregando información relevante, que permita disminuir costos y mantener las áreas verdes a pesar del actual cambio climático que vive el planeta.

Esto se puede lograr con un dispositivo de riego de bajo costo, de fácil instalación, que no necesite configuraciones, autónomo e inteligente, que permita monitorear y controlar el riego de los jardines o áreas verdes manteniéndolos en condiciones ideales de humedad con el fin de ayudar al crecimiento y desarrollo saludable del césped.

Se les ofrecerá a los usuarios monitorear y controlar el riego, entregándoles información que les puede ser de gran utilidad, como por ejemplo, el agua utilizada en un día, todo esto a través de una aplicación web y/o móvil.

\end{resumen}

%% abstract

%% contenido del primer capítulo
\chapter{Introducción}
\section{Descripción de la propuesta}
\subsection{Contexto del proyecto}
El proyecto consiste en desarrollar un sistema de riego autónomo e inteligente ideal para el uso en áreas verdes que utilizan sistemas de riego por ejemplo, por aspersión. Lo que se busca es reducir la intervención humana, aumentar la eficiencia en el uso del agua, ahorrar dinero y entregar datos estadísticos a los usuarios.

El sistema básicamente cociste en sensores de humedad del suelo, un micro computador y válvulas. Cuando un sensor detecte que la humedad del suelo no es la adecuada para mantener el césped en buen estado, le enviará una señal a la Raspberry Pi la que a su vez analiza datos meteorológicos y decide si es necesario o no hacer un riego. Con todo esto, se asegura que el jardín se encuentre en buen estado utilizando la menor cantidad de agua posible.

Para el proyecto se utiliza un micro computador el cual se programa en Python, y es el encargado de recibir los datos de entradas, que en este caso son los datos meteorológicos y los del sensor de humedad. Una vez que los datos son recibidos el micro computador los analiza y si se requiere un riego envía una señal la válvula solenoide que permitirá el paso del agua. También se utilizará un sensor de flujo para medir la cantidad de agua que se esta utilizando y así entregar reportes al usuario.

Cabe destacar que este sistema no solo es útil para los jardines, sino que también se puede utilizar para los huertos y/o predios agrícolas que utilizan sistemas de riego automáticos.

\subsection{Trabajo relacionado}

Los trabajos que hoy en día son utilizados para resolver este problema cumplen su propósito general, que es el de automatizar el riego, pero en esta solución aun se requiere la intervención de las personas que tienen que configurar el dispositivo, encendido o apagado cuando sea necesario, esto hace referencia a los sistemas que utilizan temporizadores~\cite{temporizador}. Estos dispositivos se activan cada cierto intervalo de tiempo sin tomar en cuenta variables relevantes como lo son la humedad del suelo o incluso si al momento de regar esta lloviendo. 

También existen trabajos en los que se mide la humedad del suelo~\cite{temporizadorSensorHumedad} pero aun no se utiliza eficientemente el agua. Por otro lado tampoco indican el consumo de agua que se ha utilizado en el riego y tampoco tienen sistema de prevención en caso de condiciones climáticas extremas, como puede ser el frío extremo que nos ayuden a mantener en buen estado nuestro jardín.

Estos dispositivos se pueden encontrar en tiendas de retail a costos elevados.

\subsection{Definición del problema}

Existen principalmente tres problemas que están asociados al consumo de los recursos hídricos:

Primero, la escasez de agua que existe hoy en día en gran parte de nuestro país, el año 2013 fue uno de los años más secos desde 1866. Existen déficit de precipitaciones~\cite{precipitaciones} que van desde un 20\% llegando incluso hasta un 60\% entre las zonas de Copiapó y Talca al sur, estas son zonas de gran producción agrícola además entre los lugares mencionados son los que han tenido mayor inversión para poder satisfacer la demanda de agua dulce a las personas, a esto le sumamos que este tipo de agua también es utilizada para el riego agrícola, lo que hace este recurso aún más escaso.

Segundo, se utilizan técnicas de riego pobres en la agricultura (riego áreas verdes), es por ello que es muy importante y de suma urgencia idear nuevas técnicas de riego sustentables en las que se obtenga el mayor provecho del agua sin afectar la calidad del riego.

Por último, la falta de tecnologías innovadores y baratas aplicadas al riego para el uso domestico.

\subsection{Propuesta de solución}
La solución al problema consiste en desarrollar un dispositivo de riego inteligente, automático, autónomo y de bajo costo que permita monitorear y controlar el riego de un un jardín o área verde.

Este dispositivo consta principalmente de dos partes, la primera parte es el hardware que consiste en los sensores, válvulas, actuadores y microcomputador. La segunda parte es el software que tomará la información de los sensores y la información a través de internet con la que determinará cuándo y cómo aplicar los recursos hídricos al suelo.

Para el hardware se utilizarán piezas que se venden en el mercado y son de fácil acceso, por lo que no será un problema. Para el desarrollo del software, el caso ideal sería trabajar en conjunto con un Ingeniero Agrónomo experto en riego, pero en esta oportunidad no se hará así.

Cuando y cómo aplicar un riego es muy importante ya que de esta manera se está utilizando eficientemente el agua evitando escurrimiento, evaporación, salinización y otros problemas asociados al exceso de agua en el riego.

La conexión a internet se hará utilizando dispositivos 3G que tienen una amplia cobertura a través de todo el país gracias a la iniciativa del gobierno ``Proyecto Bicentenario'' que entrega acceso al 90\% de las localidades rurales.

El dispositivo al estar conectado a internet permitirá monitorear en línea la información que se recoge a través de los sensores, por ejemplo temperatura del lugar, humedad del suelo, cantidad de agua utilizada además se podrá controlar el riego para el caso de los usuario no agricultores.

Otro punto importante consiste en alarmas, que alertarán a los usuarios cuando existan condiciones desfavorables para  el jardín como lo son las heladas en invierno, el dispositivo generará una alarma que permitirá tomar medidas de forma rápida y oportuna disminuyendo los daños que se puedan ocasionar. 

Como se espera que esto funcione de forma autónoma y utilice eficientemente el agua, no se realizarán riegos cuando exista alguna probabilidad de lluvia, por ejemplo si se espera para mañana una lluvia y los sensores de humedad indican que es necesario regar, el sistema no regará ese día o regará utilizando menos agua, esta es una característica que les será de mayor utilidad a los usuarios no agricultores ya que a ellos los que se quieren despreocupar totalmente del riego de áreas verdes.

Una variable que se considerará, distinguirá y hará diferente este dispositivo de otros existentes, es que al estar consciente de su ubicación actual podrá determinar el tipo de suelo en el que se encuentra, con esto se mejorará el impacto del riego en cada tipo de suelo, ya que permitirá saber la capacidad de absorción  que éste tiene. Con esta información se podrá saber qué tipo de riego aplica mejor con el fin de utilizar el agua  lo más inteligente y eficientemente posible.

\section{Hipótesis}
\begin{itemize}
\item El prototipo es realizable con la tecnología existente.
\item Las personas se despreocuparán por el riego de su jardín.
\item El uso de este sistema cuidará el jardín en todas las estaciones del año.
\item La utilización del dispositivo de riego disminuirá el consumo de agua.
\end{itemize}

\section{Objetivos}
\paragraph{Objetivo general}
\begin{itemize}
\item El objetivo es diseñar un prototipo inteligente de bajo costo que será utilizado en los jardines para automatizar y monitorear el riego de un jardín o áreas verdes.
\end{itemize}

\paragraph{Objetivos específicos}
\begin{itemize}
\item Diseñar un prototipo del dispositivo (Hardware).
\item Diseñar un modelo que determinar cuando y como realizar un riego (Software).
\item Diseñar un prototipo de aplicación web y/o móvil para los usuarios.
\end{itemize}

\section{Alcances}
\begin{itemize}
\item El sistema de riego (cañerías, aspersores, etc.) debe estar previamente instalado.
\item El modelo de riego será básico y se podrá mejorar con más tiempo y personas especializadas en el área.
\item En el monitoreo los usuario podrán ver la humedad del suelo y la cantidad de agua utilizada en el riego.
\item Se diseñará una aplicación web y/o móvil que permita a los usuarios visualizar la humedad del suelo y la cantidad de agua utilizada.
\item El dispositivo no se podrá configurar por parte del usuario.
\end{itemize}

\section{Metodología}

\paragraph{Objetivo 1:} ``Diseñar un prototipo del dispositivo (Hardware)''\\
\begin{itemize}
\item Determinar las piezas necesarias para construir el dispositivo.
\item Leer documentación de las piezas.
\item Juntar todas las partes para formar el dispositivo.
\item Probar el dispositivo armado.
\end{itemize}

\paragraph{Objetivo 2:} ``Diseñar un modelo que determinar cuando y como realizar un riego (Software)''\\
\begin{itemize}
\item Determinar las variables que se utilizarán.
\item Desarrollo del modelo (Desarrollo de software).
\item Probar el modelo en el dispositivo.
\end{itemize}

\paragraph{Objetivo 3:} ``Diseñar un prototipo de aplicación web y/o móvil para los usuarios''\\
\begin{itemize}
\item Diseñar mockup de aplicación web y/o móvil.
\item Desarrollo de la aplicación.
\item Pruebas de la aplicación.
\end{itemize}

%% contenido del segundo capítulo
\chapter{Marco teórico}

En este capítulo se hablará acerca en que consiste la programación del riego, los distintos tipos de suelos; que afectan en como se debe realizar un riego. Se describirá que es un servicio web y se verá el servicio que se utilizará para este proyecto mencionando las características por la cual fue escogido, finalmente se hará un breve análisis de los trabajos relacionados que existen actualmente en el mercado con una tabla comparativa y se verán los componentes tanto de hardware como de software.

\section{Programación del riego}

La programación del riego como se ve en la Figura \ref{comoregar}, es la planificación de cuándo y qué cantidad de agua aplicar con el fin de mantener el crecimiento saludable del césped. Es una práctica de gestión diaria esencial.

\begin{figure}[h]
	\centering
	\includegraphics[width=7cm]{comoregar.PNG}
	\caption{Como y cuando regar}
	\label{comoregar}
\end{figure}

El momento adecuado del riego es una decisión crucial para la aplicación: 
\begin{itemize}
\item Satisfacer las necesidades de agua, para evitar daños debido a la escasez de agua.
\item Maximizar la eficiencia del uso del agua de riego y conservar los recursos hídricos locales.
\end{itemize}

Un riego eficaz sólo es posible con un seguimiento periódico de las condiciones del agua del suelo y el desarrollo de lo que se esta cuidando (campos de cultivos o jardines) y con la previsión de las futuras necesidades de agua. Retrasar el riego hasta provoca estrés, o aplicar muy poca agua puede resultar en una pérdida sustancial. La aplicación de mucha agua se traducirá en costos adicionales y agua desperdiciada.

Existen varias herramientas que están disponibles para ayudar a un administrador el riego: sondas de suelo, sensores de humedad del suelo, estaciones meteorológicas, etc.

Para la programación del riego se utilizarán sensores de humedad del suelo y datos obtenidos de alguna estación meteorológica que entregará la probabilidad de lluvia en el lugar, cuando sea posible y a causa de que existe probabilidad de lluvia, la cantidad de agua de riego aplicada debe ser algo menor que el déficit de agua en el suelo con el fin de proporcionar el resto con la lluvia que caerá en el lugar.

Otra variable que se tendrá en cuenta, es el tipo de suelo en el que se encuentra ubicado el sistema de riego, ya que permitirá saber la capacidad de absorción  que éste tiene, con el conocimiento de esta información se podrá saber cuándo comenzar un riego con el fin de utilizar el agua de forma eficiente.


\subsection{Textura del suelo}

La textura indica el contenido relativo de partículas de diferente tamaño, como la arena, el limo y la arcilla, en el suelo. La textura tiene que ver con la facilidad con que se puede trabajar el suelo, la cantidad de agua y aire que retiene y la velocidad con que el agua penetra en el suelo y lo atraviesa.

Para conocer la textura de una muestra de suelo~\cite{sueloTextura}:
\begin{itemize}
\item Arcilloso: Se adhiere bastante, es fácilmente moldeable, las partículas no son visibles y la superficie brilla levemente.
\item Limoso: Se adhiere a los dedos, se moldea con dificultad, los dedos dan apariencia grasosa y las partículas son brillantes.
\item Arenoso: No se pega en los dedos, no se moldea como una masa y sus partículas individuales son visibles.
\end{itemize}

Cada uno de estos tipos de suelos presentan una propiedad llamada permeabilidad; que es la característica que tiene el suelo de transmitir el agua y el aire y es una de las cualidades más importantes que han de considerarse a la hora de realizar un riego. Mientras más permeable sea el suelo, mayor será la filtración.

Por regla general, como se muestra en la Figura \ref{permeabilidad}, mientras más fina sea la textura del suelo, más lenta sera la permeabilidad:

\begin{figure}[h]
	\centering
	\includegraphics[width=10cm]{permeabilidad.PNG}
	\caption{Permeabilidad según textura del suelo}
	\label{permeabilidad}
\end{figure}

\subsection{Como regar los suelos}

\subsubsection{Suelo arenoso}

Para un suelo arenoso, se debe aplicar agua con más frecuencia que los suelos limosos o arcillosos. El agua drena rápidamente a través de la arena, por lo que no estarán disponibles cuando las plantas lo necesitan, por lo que hay que regar con poca cantidad pero con más frecuencia.

\subsubsection{Suelo limoso}

Para un suelo limoso, se debe puede aplicar agua constantemente durante un periodo de tiempo determinado. El agua drena con una velocidad moderada.

\subsubsection{Suelo arcilloso}

Los suelos arcillosos drenan mal el agua, debido a la pequeñez de sus partículas. Por ello se encharcan. Se debe aplicar agua con menor frecuencia que los suelos limosos y arenosos.\\


En la Figura \ref{infiltracion} se puede apreciar la reacción de cada tipo de suelo cuando se le aplica agua.

\begin{figure}[h]
	\centering
	\includegraphics[width=10cm]{suelo.png}
	\caption{Variación en la infiltración por textura del suelo}
	\label{infiltracion}
\end{figure}

\section{Problemas identificados}

Según Chuck Ingels~\cite{problemas}, asesor agrícola de Extensión Cooperativa de la Universidad de California en el condado de Sacramento y Loren Oki, especialista de Extensión Cooperativa en el Departamento de Botánica de UC Davis y especialista en horticultura de paisajes, existen problemas en los sistemas de riego actuales que hoy en día son utilizados, ellos nombran principalmente cuatro problemas: 

\begin{itemize}
\item ``Apagar el sistema de riego por aspersores después de que llueve es el primer paso que se debe tomar para ahorrar agua''
\item ``El riego de césped y jardines representa más de la mitad del agua usada en un hogar promedio''
\item ``Ha llevado a cabo estudios sobre un problema común relacionado al riego de céspedes residenciales en California: el escurrimiento de agua''
\item ``Mucha del agua que se aplica a los céspedes termina directamente en las alcantarillas. No solo se trata de agua desperdiciada; hemos descubierto también que el agua de escurrimientos arrastra contaminantes (incluyendo pesticidas y fertilizantes) hasta las alcantarillas y, eventualmente, a los canales y vías fluviales. El problema radica en que los sistemas de aspersores típicos aplican agua de forma más rápida que la que la tierra puede absorber, lo cual lleva al escurrimiento''
\end{itemize}

\section{Información disponible}

Para los problemas anteriormente mencionados existe información que será utilizado para planificar y determinar un riego, los podemos ver a continuación:

\begin{itemize}
\item Pronóstico del tiempo: se cuenta con esta información que permite saber en tiempo actual las condiciones climáticas de un punto en particular.
\item Ubicación del dispositivo: se puede determinar la ubicación del dispositivo utilizando un GPS, si se utiliza en lugares con acceso a Internet en los que no se utilice el módem 3G, se podría determina la ubicación a través de la dirección IP.
\item Tipo de suelo: indica el tipo de suelo en el que el dispositivo esta siendo utilizado, esta información se obtiene utilizando la ubicación del dispositivo.
\item Humedad del suelo: indica la humedad del suelo utilizando sensores de humedad.
\end{itemize}

Existe más información que puede ser incluida para mejorar la calidad del riego aplicado al suelo, pero para este trabajo solo se considera las variables mencionadas anteriormente.

\section{Sistema basado en reglas}

En la vida diaria encontramos muchas situaciones complejas las que se rigen por reglas deterministas: sistemas de control de tráfico, sistemas de seguridad, transacciones bancarias, entro otros. Los sistemas basados en reglas~\cite{sistemaReglas} son una herramienta eficiente para tratar estos problemas. 

Las reglas deterministas componen la más sencilla de las metodologías utilizadas en sistemas expertos. La base de conocimiento contiene las variables y el conjunto de reglas que definen el problema, y el motor de inferencia obtiene las conclusiones aplicando la lógica clásica a estas reglas. Por regla se entiende una proposición lógica que relaciona dos o más objetos e incluye dos partes, la premisa y la conclusión. Cada una de estas partes consiste en una expresión lógica con una o más afirmaciones objeto-valor conectadas mediante los operadores lógicos \textit{y}, \textit{o}, o \textit{no}. Una regla se escribe normalmente como ``Si premisa, entonces conclusión''. 

Como ejemplo de problema determinista que puede ser formulado usando un conjunto de reglas, considérese una situación en la que un usuario (por ejemplo, un cliente) desea sacar dinero de su cuenta corriente mediante un cajero automático (CA). En cuanto el usuario introduce la tarjeta en el CA, la maquina la lee y la verifica. Si la tarjeta no es verificada con éxito (por ejemplo, porque no es legible), el CA devuelve la tarjeta al usuario con el mensaje de error correspondiente. En otro caso, el CA pide al usuario su número de identificación personal (NIP). Si el número fuese incorrecto, se dan tres oportunidades de corregirlo. Si el NIP es correcto, el CA pregunta al usuario cuánto dinero desea sacar. Para que el pago se autorice, la cantidad solicitada no debe exceder de una cierta cantidad limite diaria, además de haber suficiente dinero en su cuenta. 

En este caso se tienen siete objetos, y cada objeto puede tomar uno y sólo un valor de entre sus posibles valores. La Figura \ref{valores} muestra estos objetos y sus posibles valores.

\begin{figure}[h]
\centering
\includegraphics[width=6cm]{valores.png}
\caption{Objetos y posibles valores para el ejemplo del cajero automático}
\label{valores}
\end{figure}

\pagebreak 

La Figura \ref{reglas} muestra siete reglas que gobiernan la estrategia que el CA debe seguir cuando un usuario intenta sacar dinero de su cuenta.

\begin{figure}[h]
\centering
\includegraphics[width=7cm]{reglas.png}
\caption{ Ejemplos de reglas para sacar dinero de un cajero automático}
\label{reglas}
\end{figure}

\pagebreak

Tal como se ha mencionado, hay dos tipos de elementos: los datos (hechos o evidencia) y el conocimiento (el conjunto de reglas almacenado en la base de conocimiento).

Para obtener conclusiones, los expertos utilizan diferentes tipos de reglas y estrategias de inferencia y control:

\begin{itemize}
\item Modus Ponens
\item Modus Tollens
\end{itemize}

y las estrategias de inferencia:

\begin{itemize}
\item Encadenamiento de reglas
\item Encadenamiento de reglas orientado a un objetivo
\end{itemize}

\subsection{Modus Ponens}
El Modus Ponens es quizás la regla de inferencia más comúnmente utilizada. Se
utiliza para obtener conclusiones simples. En ella, se examina la premisa de la regla, y si es cierta, la conclusión pasa a formar parte del conocimiento. Por ejemplo, suponga que se tiene la regla, ``Si A es cierto, entonces B es cierto'' y que se sabe además que ``A es cierto''. La regla Modus Ponens concluye que ``B es cierto.'' 

\subsection{Estrategias de inferencia}

Una de las estrategias de inferencia más utilizadas para obtener conclusiones compuestas es el encadenamiento de reglas.
Esta estrategia puede utilizarse cuando las premisas de ciertas reglas coinciden con las conclusiones de otras. Cuando se encadenan las reglas, los hechos pueden utilizarse para dar lugar a nuevos hechos, este proceso se repite sucesivamente hasta que no pueden obtenerse más conclusiones. El tiempo que consume este proceso hasta su terminación depende, por una parte, de los hechos conocidos, y, por otra, de las reglas que se activan.

Existen dos tipos de encadenamiento: progresivo y regresivo:

\subsubsection{Encadenamiento progresivo}

Este tipo de encadenamiento se produce cuando el objetivo propuesto hace que se ejecute una regla, y la conclusión obtenida permite que se ejecute otra, y así sucesivamente hasta llegar a una respuesta, positiva o negativa. El punto final se detecta cuando no se pueden producir más encadenamientos.

\section{Servicios web meteorológicos}

\subsection{¿Qué es un servicio web?}
Los servicios web son sistemas de software que permiten el intercambio de datos y funcionalidad entre aplicaciones sobre una red. Esta soportado en diferentes 
estándares que garantizan la interoperabilidad de los servicios~\cite{webService}.

En la Figura \ref{rest}, se puede apreciar la arquitectura de un servicio web, se ve que el cliente realiza un petición al servidor y éste le envía una respuesta con lo solicitado.

\begin{figure}[h]
\centering
\includegraphics[width=9cm]{rest.jpg}
\caption{Arquitectura servicio web}
\label{rest}
\end{figure}

\newpage

Un servicio web REST, es un servicio implementado usando HTTP y que entrega como resultado en formato XML o JSON de los cuales se puede obtener la información solicitada.

\subsection{Wunderground}
Weather Underground es un servicio que entrega información meteorológica que ha desafiado las convenciones en torno a cómo la información del tiempo se comparte con el público desde 1993. Se ha creado con el fin de mejorar el acceso de las personas a los datos meteorológicos significativos de todo el mundo. Como servicio meteorológico primero de Internet, son considerados pioneros en su campo y están en constante búsqueda de nuevos conjuntos de datos y tecnologías que ayuden a compartir más datos con más gente.

Wunderground no da la posibilidad de consultar el clima dado las coordenadas de la posición en la que un punto se encuentra, estas coordenadas pueden ser obtenidas de forma automática utilizando un GPS o ingresándolas manualmente. Para utilizar el servicio, es necesario registrarse para obtener un llave que se utiliza para realizar las consultas meteorológicas.

Las características de este servicio web y las razones por las que se decidió utilizarlo son las siguientes:

\begin{itemize}
\item Las consulta para obtener la información meteorológica son gratuitas.
\item Se adecua perfectamente a las necesidades del proyecto, tanto en los datos requeridos como en la forma de solicitar éstos.
\item Se pueden realizar hasta 24 consultas por día.
\item Los resultados obtenidos son bastante parecidos entre lo que entrega Google y Wunderground como se puede ver en la Figura: \ref{climacorcolen} y para fines de este proyecto es suficiente (Suponiendo que Google entrega resultados confiables).
	\begin{figure}[h]
	\centering
	\includegraphics[width=15cm]{meteorologia.png}
	\caption{Comparación servicio meteorológico de Google v/s Wunderground para la localidad rural de Corcolén}
	\label{climacorcolen}
	\end{figure}
\end{itemize}


Para obtener más información y/o registrarse para utilizar el servicio visitar la página web.\footnote{http://www.wunderground.com/weather/api/d/docs?d=index}\\

\section{Trabajos relacionados}
A continuación se mencionan algunos de los dispositivos que se utilizan actualmente para automatizar el riego de los jardines.

\subsection{Cultivar}
Cultivar está desarrollando y fabricando por Raincloud~\cite{raincloud}. Raincloud administra de forma conveniente e inteligente la gestión del agua, con un sistema de riego conectado a la web que permite monitorear en todo momento es estado del sistema. Raincloud vincula los dispositivos móviles permitiendo activar válvulas de agua y consultar sensores de humedad utilizando Wi-Fi.\\

Ventajas:
\begin{itemize}
\item Utiliza sensores de humedad de suelo.
\item Se controla a través de un teléfono móvil.
\item Consume la menor cantidad de agua posible.
\item Almacena los datos en la nube.
\item Entrega estadísticas del consumo de agua.
\end{itemize}

Desventajas:
\begin{itemize}
\item Necesita configuración previa.
\item Se necesita Wi-Fi en el hogar para su óptimo funcionamiento.
\item Tiene un costo muy elevado (\$344.000 pesos).
\item No toma en cuenta datos meteorológicos.
\end{itemize}

\subsection{Rachio IRO}
Iro~\cite{rachio} es un controlador de riego inteligente que permite a las personas de manera fácil, mantener sus jardines en buen estado. Se integra de manera fácil al Wi-Fi de su hogar, entregando un completo control a través de su computador o teléfono móvil.

Rachio se ajusta automáticamente a los datos meteorológicos del lugar en el que se encuentra, estación del año, tipo de zona y características de la región.\\

Ventajas:
\begin{itemize}
\item Se controla a través de un teléfono móvil o una computador.
\item Puede funcionar de forma automática. 
\item Se ajustara automáticamente a el clima.
\item Consume la menor cantidad de agua posible.
\item No necesita programarse.
\item Entrega estadísticas del consumo de agua.
\end{itemize}

Desventajas:
\begin{itemize}
\item No utiliza sensores de humedad de suelo.
\item Se necesita Wi-Fi en el hogar para su óptimo funcionamiento.
\item Tiene un costo muy elevado (\$180.000 pesos).
\end{itemize}

\subsection{Rain Bird}
El Programador 6 Estaciones Digital Rain Bird~\cite{rainbird} (temporizador)logra, gracias a su particular panel con diversas opciones, controlar y personalizar tu sistema de riego. Si bien tiene claras opciones para potenciar el jardín, este producto exterioriza sus habilidades para centrarse en distintos planos y superficies. Con el fin de que tus zonas verdes comprendan el mismo cuidado que el interior de tu casa, este producto te da total control de lo que desees lograr, entregándote oportunidades específicas de acción que se ajustan a las necesidades diarias.

Entre las características del Programador 6 Estaciones Digital Rain Bird se puede encontrar su tablero altamente definido que te da la posibilidad, de manera sencilla, de regular y hacer mejor uso del suministro de agua, debido al despliegue uniforme y sistemático de las acciones de los riegos. Al poseer un esquema de operación para tu el jardín, podrás lograr una constancia en los procesos de crecimiento de tu extensa flora, demostrando que la sencillez de este producto es una cualidad para considerar. 

Ventajas:
\begin{itemize}
\item Programación basada en zonas, que permite asignar programas independientes a cada zona.
\item Puede funcionar de forma automática. 
\end{itemize}

Desventajas:
\begin{itemize}
\item No utiliza sensores de humedad de suelo.
\item No tiene control remoto.
\item No entrega información del consumo de agua.
\item No tiene información meteorológica, por lo que puede hacer un riego cuando este lloviendo.
\item Tiene un costo muy elevado (\$65.990 pesos).
\end{itemize}


\subsection{Tabla comparativa}
En la Figura: \ref{tablaComparativa} se muestra las características de cada uno de los dispositivos que actualmente se utilizan en el mercado y además se incluye el trabajo que se esta realizando en esta memoria.
Las características descritas en la tabla son necesarias para realizar un riego eficiente y se puede ver que los dispositivos incluyen algunas des estas, pero no están todas incluidas en uno solo y es lo que se espera lograr con este trabajo.

También se puede apreciar que ningún dispositivo toma en cuenta el tipo de suelo que es regando, una variable a considerar si se desea maximizar el uso del agua.

\begin{figure}[h]
\centering
\includegraphics[width=15cm]{tablaComparativa.png}
\caption{Tabla Comparativa}
\label{tablaComparativa}
\end{figure}


\section{Hardware}
Todas las partes físicas de un sistema que tiene componentes: eléctricos, electrónicos, electromecánicos y mecánicos. Para la construcción del sistema de riego se necesitarán una serie de componentes, sensores, actuadores y computadores para su correcto funcionamiento.

\subsection{Raspberry pi}
Raspberry Pi~\cite{raspberry} es un microcomputador del tamaño de una tarjeta de crédito a bajo costo que se conecta a un monitor o un televisor, utiliza un teclado y un ratón estándar. Es un dispositivo que permite a las personas de todas las edades explorar la computación y aprender a programar en lenguajes como Python. Es capaz de hacer todo lo que espera de una computadora de escritorio, desde navegar por Internet y reproducir vídeos en alta definición, trabajar en hojas de cálculo, procesadores de texto, y jugar.

Raspberry Pi tiene la capacidad de interactuar con el mundo exterior, y se ha utilizado en una amplia gama de proyectos digitales, máquinas de música y detectores en las estaciones meteorológicas.

La función de la Raspberry Pi es obtener toda la información de los sensores a través del arduino, obtener datos meteorológicos, obtener los tipos de suelo y utilizando toda esta información determinar cuándo se debe realizar un riego, activando un relé. También envía la información de humedad de suelo y agua utilizada a un servidor.

\begin{figure}[h]
\centering
\includegraphics[width=5cm]{rasp.png}
\caption{Raspberry Pi modelo B+}
\label{rasp}
\end{figure}


\subsection{Arduino}
Arduino~\cite{arduiino} es una plataforma de prototipos electrónica de código abierto (open-source) basada en hardware y software flexibles y fáciles de usar. Está pensado para artistas, diseñadores, como hobby y para cualquiera interesado en crear objetos o entornos interactivos.
Arduino puede sentir el entorno mediante la recepción de entradas desde una variedad de sensores y puede afectar a su alrededor mediante el control de luces, motores y otros artefactos. 

\begin{figure}[h]
\centering
\includegraphics[width=5cm]{arduino.png}
\caption{Arduino}
\label{arduino}
\end{figure}

\subsection{Servidor de base de datos}
Un servidor de bases de datos se utiliza para almacenar, recuperar y administrar los datos de una base de datos, cuando hablamos de datos, podemos estar hablando sobre millones de elementos a los que acceden al mismo tiempo miles de usuarios. El servidor gestiona las actualizaciones de datos, permite el acceso simultáneo de muchos servidores o usuarios web y garantiza la seguridad y la integridad de los datos.

Así como sus funciones básicas, el software de servidores de bases de datos ofrece herramientas para facilitar y acelerar la administración de bases de datos. Algunas funciones son la exportación de datos, la configuración del acceso de los usuarios y el respaldo de datos.

Se utilizará PostgreSQL como sistema de gestión de base de datos que es libre y tiene un complemento llamado PostGIS que añade soporte de objetos geográficos a la base de datos, esta característica será utilizada en conjunto con el GPS determinar el tipo de suelo en el que el dispositivo se encuentra.
PostGIS permite saber si un punto se encuentra dentro de un polígono con la función ``contains'', con esta función se pudo determinar dentro de que polígono (que corresponde al tipo de suelo) se encontraba la coordenada.

\subsection{Servidor web}
Básicamente, un servidor web sirve contenido estático a un navegador, carga un archivo y lo sirve a través de la red al navegador de un usuario. Este intercambio es mediado por el navegador y el servidor que hablan el uno con el otro mediante HTTP.

Su función en este proyecto es almacenar todos los datos que envía el dispositivo. También se almacenará una aplicación web para que los usuarios puedan consultar información relacionada al riego.

\subsection{Sensores de humedad}
Existen varios tipos de sensores de humedad~\cite{sensor}

\begin{itemize}
\item Mecánicos: aprovechan los cambios de dimensiones que sufren cierto tipos de materiales en presencia de la humedad.
\item Basados en sales higroscópicas: deducen el valor de la humedad en el ambiente a partir de una molécula cristalina que tiene mucha afinidad con la absorción de agua.
\item Por conductividad: la presencia de agua en un ambiente permite que a través de unas rejillas de oro circule una corriente. Ya que el agua es buena conductora de corriente. Según la medida de corriente se deduce el valor de la humedad.
\item Capacitivos: se basan sencillamente en el cambio de la capacidad que sufre un condensador en presencia de humedad.
\item Infrarrojos: estos disponen de 2 fuentes infrarrojas que lo que hacen es absorber parte de la radiación que contiene el vapor de agua.
\item Resistivos: aplican un principio de conductividad de la tierra. Es decir, mientras más agua hay en la muestra, más alta es la conductividad de la tierra.
\end{itemize}

En este proyecto se utilizarán sensores resistivos, ya que son baratos y se pueden encontrar en cualquier parte.

La desventaja es que su tiempo de vida útil es corto.

\begin{figure}[h]
\centering
\includegraphics[width=5cm]{sensorHumedad.jpg}
\caption{Sensor de humedad}
\label{snsorHumedad}
\end{figure}

\subsection{Sensor de flujo de agua}
Un sensor de flujo de agua consiste en una válvula de cuerpo plástico, un rotor de agua y un sensor de efecto hall. Cuando el agua fluye a través del rotor, el rotor gira. Su velocidad cambia con diferentes ritmos de flujo. El sensor de efecto hall tiene como salida la señal de pulso correspondiente.

Será utilizado para medir la cantidad de agua utilizada en riego para que los usuarios manejen esta información.

\begin{figure}[h]
\centering
\includegraphics[width=6cm]{sensorFlujo.jpg}
\caption{Sensor de flujo de agua}
\label{sensorFlujo}
\end{figure}

\pagebreak

\subsection{Relé}

Un relé de estado sólido es un dispositivo interruptor electrónico que conmuta el paso de la electricidad cuando una pequeña corriente es aplicada en sus terminales de control. Los relé de estado solido consisten en un sensor que responde a una entrada apropiada (señal de control), un interruptor electrónico de estado sólido que conmuta el circuito de carga, y un mecanismo de acoplamiento a partir de la señal de control que activa este interruptor sin partes mecánicas. El relé puede estar diseñado para conmutar corriente alterna o continua. Hace la misma función que el relé electromecánico, pero sin partes móviles.

La principal ventaja de utilizar un relé de esta solido es que utilizan una menor tensión de trabajo, se activan desde 1,5V o menos lo que lo hace ideal para trabajar con la Raspberry Pi, que sus salidas de corrientes son de 3V - 5V.

El relé es utilizado como interruptor para activar la válvula solenoide. No se usa la Raspberry Pi directamente ya que para activar la válvula se necesitan 12V.

\begin{figure}[h]
\centering
\includegraphics[width=5cm]{rele.jpg}
\caption{Relé de estado solido}
\label{rele}
\end{figure}

\pagebreak

\subsection{Válvula solenoide}
Una válvula solenoide esta diseñada para controlar el paso de un fluido por un conducto o tubería. La válvula se mueve mediante una bobina solenoide. Generalmente no tiene más que dos posiciones: abierto y cerrado, o todo y nada. Las electroválvulas se usan en multitud de aplicaciones para controlar el flujo de todo tipo de fluidos.

La válvula se activa al aplicarle un voltaje de 12V.

Se utilizará para permitir el paso del agua al sistema de riego del jardín.

\begin{figure}[h]
\centering
\includegraphics[width=6cm]{valvulasolenoide.jpg}
\caption{Válvula solenoide}
\label{valvulasolenoide}
\end{figure}

\subsection{GPS}
GPS~\cite{gps} es un sistema que tiene como objetivo la determinación de las coordenadas espaciales de puntos respecto de un sistema de referencia mundial. Los puntos pueden estar ubicados en cualquier lugar del planeta, pueden permanecer estáticos o en movimiento y las observaciones pueden realizarse en cualquier momento del día. Para la obtención de coordenadas el sistema se basa en la determinación simultánea de las distancias a cuatro satélites (como mínimo) de coordenadas conocidas. Estas distancias se obtienen a partir de las señales emitidas por los satélites, las que son recibidas por receptores especialmente diseñados. Las coordenadas de los satélites son provistas al receptor por el sistema.

El GPS se utilizará para determinar la ubicación exacta en la que el dispositivo se encuentra instalado, con esta información se determinará el tipo de suelo y se aplicará el riego más conveniente.

\begin{figure}[h]
\centering
\includegraphics[width=6cm]{gps.jpg}
\caption{Módulo GPS USB}
\label{gps}
\end{figure}

\subsection{Módem 3G}
Módem 3G es un terminal de red inalámbrica basada en la tecnología CDMA2000. Es la mejor opción para los usuarios que necesitan acceder a Internet desde cualquier lugar en cualquier momento. El módem está conectado al micro computador mediante una interfaz USB.

El módem se utilizará para comunicar el dispositivo con el servidor donde se almacenarán los datos, consultar los datos meteorológicos y obtener el tipo de suelo.

\begin{figure}[h]
\centering
\includegraphics[width=4cm]{modem.jpg}
\caption{Módem 3G}
\label{modem}
\end{figure}

\pagebreak

\subsection{Cargador}
Un cargador es un dispositivo utilizado para suministrar corriente eléctrica a un dispositivo, que en este caso se tratará de la Raspberry Pi. El cargador debe funcionar a 5V y entregar una corriente de 700mA.

Será utilizado para entregarle energía a la Raspberry Pi para que pueda funcionar correctamente en conjunto con los sensores y válvulas.

\begin{figure}[h]
\centering
\includegraphics[width=4cm]{cargador.jpg}
\caption{Cargador}
\label{cargador}
\end{figure}



\subsection{Costo componentes}
En el Cuadro \ref{precios} se detallan los costos de cada componente necesario para la construcción, esto tiene un total de \$ 50.110 pesos que es lo que cuesta construir el prototipo.


\begin{table}[h]
\centering
\caption{Tabla de precios}
\label{precios}
\begin{tabular}{|l|r|}
\hline
\textbf{Componente}        & \multicolumn{1}{l|}{\textbf{Precio (pesos)}} \\ \hline
Raspberry Pi               & \$         28.400                            \\
Arduino                    & \$           3.500                           \\
Sensor de Humedad de Suelo & \$              700                          \\
Sensor de Flujo de Agua    & \$           2.700                           \\
Relé de Estado Solido      & \$           3.500                           \\
Valvula Solenoide          & \$           3.500                           \\
Gps                        & \$           7.100                           \\
Cargador                   & \$              710                          \\ \hline
\textbf{Total}             & \textbf{\$          50.110}                  \\ \hline
\end{tabular}
\end{table}

\section{Software}
\subsection{Raspbian}
Raspbian~\cite{raspbian} es un sistema operativo libre basado en Debían optimizado para el hardware Raspberry Pi. Raspbian no tiene relación con la Fundación Raspberry Pi, fue creado por un pequeño y dedicado equipo de desarrolladores que son fans del hardware Raspberry Pi\footnote{https://www.raspbian.org/RaspbianInstaller}.

Raspbian ofrece más que un sistema operativo; viene con más de 35.000 paquetes, software pre-compilado en un formato que hace más fácil la instalación en su Raspberry Pi que permiten hacer muchas cosas diferentes en distintos ámbitos .

\subsection{Python}
Python es un claro  y poderoso lenguaje de programación orientado a objetos, comparable con Perl, Ruby o Java.

Algunas de las características de Python\footnote{https://wiki.python.org/moin/BeginnersGuide/Overview} son:

\begin{itemize}
\item Python ideal para el desarrollo de prototipos y otras tareas de programación, sin comprometer la capacidad de mantenimiento.
\item Utiliza una sintaxis clara, por lo que los programas son fáciles de leer.
\item Viene con una biblioteca estándar que soporta muchas tareas comunes de programación, tales como la conexión a los servidores web, la búsqueda de texto con expresiones regulares, leer y modificar archivos.
\item Es software libre.
\item Tiene librerías que facilitan el uso de la interfaz GPIO de la Raspberry Pi.
\end{itemize}

\subsubsection{Librería GPIO}
Una de las características de gran alcance de la Raspberry Pi es la fila de GPIO~\cite{gpio} (Entrada/Salida de Propósito General) alfileres a lo largo del borde de la placa, junto a la salida de vídeo socket amarilla como se puede apreciar en la Figura \ref{gpio}:

\begin{figure}[h]
\centering
\includegraphics[width=9cm]{gpio.jpg}
\caption{GPIO Raspberry Pi}
\label{gpio}
\end{figure}

Estos pines son una interfaz física entre el la Raspberry Pi y el mundo exterior. Al nivel más simple, se puede pensar en ellos como interruptores que puede activar o desactivar ya sean las entradas como las salidas. Diecisiete de los veinte y seis pines son GPIO; los otros son pines de alimentación o de tierra como se ve en la Figura \ref{giop1}:

\begin{figure}[h]
\centering
\includegraphics[width=9cm]{giop1.png}
\caption{Pines GPIO}
\label{giop1}
\end{figure}

¿Qué se puede hacer con esto?\\

Se puede programar los pines de maneras asombrosas para interactuar con el mundo real. Las entradas no tienen que venir de un interruptor físico; podría ser la entrada de un sensor o una señal de otro ordenador o dispositivo, por ejemplo. La salida también puede hacer cualquier cosa, desde encender un LED con el envío de una señal o de datos a otro dispositivo. Si la Raspberry Pi está en una red, puede controlar los dispositivos que están conectados a él desde cualquier lugar. Conectividad y control de los dispositivos físicos a través de Internet es algo muy poderoso y emocionante, y la Raspberry Pi es ideal para esto.

%contenido cuarto capitulo
\chapter{Desarrollo}

En este capitulo se mostrarán los pasos necesarios para construir y hacer funcionar el dispositivo de riego. Primero veremos todo lo relacionado con el hardware juntado todas las partes, luego se trabajará en el desarrollo del modelo que corresponde a la parte de software del dispositivo. También se mostrará brevemente el desarrollo de la aplicación web y finalmente veremos las variables necesarias para determinar un helada y como se hará para notificar a los usuarios.

\section{Hardware}

Raspberry Pi es una plataforma muy útil para el desarrollo de aplicaciones domóticas y de control. Sin embargo. Raspberry Pi tiene una limitación en cuanto a entradas/salidas disponibles y no puede trabajar con modulación por ancho de pulsos.

Una solución a este problema puede ser utilizar un Beaglebone black o se puede combinar el Raspberry Pi con Arduino y dejar todo el control de hardware al Arduino y solo utilizar la Raspberry Pi como controlador. En esta sección se mostrará como conectar la Raspberry Pi con un Arduino a través de USB a través de comunicación serie.

\subsection{Arduino}

\subsubsection{Programación Arduino}

Lo primero que se hará es crear un programa para Arduino que leerá la información de uin sensor de humedad y la información que envía un sensor de flujo utilizando el puerto serie del Arduino. El programa que utilizamos se muestra a continuación, para ello se debe instalar el IDE de Arduino\footnote{https://www.arduino.cc/en/Main/Software}

Instalado el programa, conectar al Arduino a la computadora, ejecutar el programa y ya se esta listo para trabajar.

En el Listing \ref{arduino} se muestra el código con el cual se puede leer información desde los distintos tipos de sensores utilizados.\\

\lstset{language=C, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Código Arduino},label=arduino]
volatile int  frecuencia_sensor;  // Mide los pulsos de flujo
unsigned int  litrosHora;          // Calcula los litros por hora  
unsigned int humedad_sensor;        // Mide la humedad del suelo                    
unsigned char pinFlujo = 2;  // Pin de flujo
unsigned char pinHumedad = A0;  // Pin de humedad
unsigned long tiempoActual;
unsigned long tiempoCiclo;

void flujo ()                  // Interruot function
{ 
  frecuencia_sensor++;
}

void setup() {
  pinMode(pinFlujo, INPUT);
  Serial.begin(9600); 
  attachInterrupt(0, flujo, RISING); // Setup Interrupt 
  sei();                            // Enable interrupts  
  tiempoActual = millis();
  tiempoCiclo = tiempoActual;
}

void loop() {
  humedad_sensor = analogRead(pinHumedad);
  //Serial.print(humedad_sensor);
  //Serial.println(" Humedad");
  tiempoActual = millis();
  //Cada segundo, calcula e imprime litros por hora
  if(tiempoActual >= (tiempoCiclo + 1000))
  {     
    tiempoCiclo = tiempoActual;              // Actualiza tiempoCiclo
    litrosHora = (frecuencia_sensor * 60 / 7.5); // (Pulse frequency x 60 min) / 7.5Q = L/hour 
    frecuencia_sensor = 0;                   // Resetea el contador
    //Serial.print(litrosHora);            // Imprime litro por hora
    //Serial.println(" L/hour");
    //Serial.print(humedad_sensor);
    //Serial.println(" Humedad");
    Serial.println(String(humedad_sensor) + " " + String(litrosHora));
  }
}
\end{lstlisting}

Una vez escrito el código en el IDE, se verifica y se sube al Arduino. Es importante destacar que para enviar información a las Raspberry Pi se utiliza la linea de código Serial.println(``mensaje'').

\subsubsection{Conexión de sensores}

Como se ha mencionado anteriormente, los sensores que se utilizarán son de humedad de suelo y flujo de caudal, y se mostró el código necesario para que estos funcionen. De acuerdo a ese código se es que se realizó la conexión de los sensores al Arduino, se puede apreciar claramente en la Figura \ref{conexion}:

\begin{figure}[h]
\centering
\includegraphics[width=12cm]{conexiones.jpg}
\caption{Conexión sensores en Arduino}
\label{conexion}
\end{figure}

VCC: Alimentación positiva del circuito.

GND: Alimentación negativa del circuito.

AO: Salida analógica del sensor o válvula.


\subsection{Raspberry Pi}

Para configurar la Raspberry Pi lo primero que hay que hacer es instalar las librerías para el control del puerto serie desde Python. Para hacer esto ejecutamos el siguiente comando desde la consola en nuestra Raspberry Pi:

\textit{sudo apt-get install python-serial}

Con esto instalado ya esta lista la Raspberry Pi para comunicarse al Arduino utilizando el puerto serie. Lo que hay que determinar es que puerto utiliza el Arduino cuando esta conectado al Raspberry Pi. Para saber el puerto primero se conecta el Arduino a la Raspberry Pi por USB y luego se ejecuta el siguiente comando:

\textit{ls /dev/tty*}

Una vez ejecutado el comando se verá un listado de diferentes dispositivos. El Arduino en este caso aparece en el último lugar llamado /dev/ttyUSB0 como se ve el la Figura \ref{resultado}:

\begin{figure}[h]
\centering
\includegraphics[width=14cm]{USBArduino.png}
\caption{Arduino en Raspberry Pi}
\label{resultado}
\end{figure}

\newpage

Una vez que el Arduino esta identificado ya podemos comenzar a comunicarnos mediante un programa en Python. En este caso se mostrará un ejemplo de como recibir la información en la Raspberry Pi enviada desde el Arduino, en la Figura \ref{raspardu} se puede ver el código utilizado.


\begin{figure}[h]
\centering
\includegraphics[width=14cm]{RaspberryArduino.png}
\caption{Comunicación Raspberry Pi Arduino}
\label{raspardu}
\end{figure}

\pagebreak

Con este programa en Python ya se puede recibir datos desde el Arduino en la Raspberry Pi, para probarlo se ejecuta el programa con la siguiente linea de código \textit{sudo python nombre\_programa.py}. Los resultados obtenido en la Figura \ref{raciboDatos}

\begin{figure}[h]
\centering
\includegraphics[width=14cm]{ReciboDatos.png}
\caption{Recibo de datos desde Arduino en Raspberry Pi}
\label{raciboDatos}
\end{figure}

\subsection{GPS}
El GPS es una parte importante del dispositivo, ya que determina la posición en la que se aplicará el riego, gracias a esto se puede determinar el tipo de suelo en el que el dispositivo se encuentra y realizar un riego especial a cada lugar.

El GPS se conectará a la Raspberry Pi ya que utiliza conexión USB.

Pasos para el funcionamiento del GPS en la Raspberry Pi:

\begin{itemize}
\item Conectar el GPS a un puerto USB de la Raspberry Pi.
\item En la terminal de Raspberry Pi ejecutar \textit{ls /dev/tty*} como se ve en la Figura \ref{lsgps}:

\begin{figure}[h]
\centering
\includegraphics[width=14cm]{lsgps.png}
\caption{GPS en Raspberry Pi, /dev/ttyUSB1}
\label{lsgps}
\end{figure}

\pagebreak

\item \textit{sudo gpsd -N -D3 /dev/ttyUSB1} 
\item \textit{sudo nano gps.py}
\item En el archivo creado anteriormente copiar el código del siguiente link:

\url{https://gist.github.com/wolfg1969/4653340#file-gpsddata-py}
\item Ejecutar \textit{sudo python gps.py} con esto obtenemos como resultado lo que se aprecia en la Figura \ref{datosgps}:

\begin{figure}[h]
\centering
\includegraphics[width=14cm]{datosgps.png}
\caption{Datos GPS}
\label{datosgps}
\end{figure}

\pagebreak

\end{itemize}


\section{Software}

\subsection{Información meteorológica}

La estructura de la url para realizar la consulta de la siguiente:

\url{http://api.wunderground.com/api/e7d949410a7481dc/forecast10day/lang:SP/q/-34.40819094134256,-71.00087251514196.json}

\begin{itemize}
\item \url{http://api.wunderground.com/api/} es la dirección donde se hace la consulta.
\item \url{e7d949410a7481dc} es la llave que se obtiene al registrarse y es necesaria para utilizar el servicio.
\item \url{forecast10day} retorna datos meteorológicos de los siguientes 10 días.
\item \url{lang:SP} se utiliza para obtener los datos en español.
\item \url{q/-34.40819094134256,-71.00087251514196} son las coordenadas del lugar que se quieren obtener los datos.
\item \url{.json} es el formato en el que se devuelve la información, también puede ser .xml.
\end{itemize}

Los datas obtenidos se pueden apreciar en la Figura \ref{response} y la información más relevante es ``pop'' que informa de la probabilidad de lluvia que hay en el lugar.

\begin{figure}[h]
\centering
\includegraphics[width=15cm]{response.png}
\caption{Respuesta del servicio wunderground al hacer una consulta}
\label{response}
\end{figure}

\subsection{Modelo de riego}

La principal función del modelo de riego es determinar cuando hacer un riego en base a los datos que tiene disponible, también indicará que tipo de riego se debe hacer en base al tipo de suelo en el que el dispositivo se encuentra instalado. Esto se hará mediante un sistema basado en reglas que ya fue explicado anteriormente.

¿Cuando se ejecutará el modelo? El modelo de riego se ejecutará cada mañana a las 6 a.m y el tiempo de riego será de 20 min. La hora fue escogida para evitar la evaporación del agua y daños que se le puedan dañar el césped a causa del sol. El código que realiza esta acción se ve en el Listing \ref{controlRiego}:

\pagebreak

\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Control de riego},label=controlRiego]
while True:
	hora = datetime.datetime.now().time()
	if (hora>=datetime.time(6,00) and hora<=datetime.time(6,20)):
		if suelo == "arenoso":
			#ReigoArenoso
		else if suelo == "limoso":
			#RiegoLimoso
		else:
			#RiegoArcilloso
\end{lstlisting}


Los datos disponibles para determinar un riego son los que se aprecian en el Cuadro \ref{objetos}, también se pueden ver los valores asociados a cada objeto.

\begin{table}[h]
\centering
\caption{Objetos y posibles valores para determinar un riego}
\label{objetos}
\begin{tabular}{|l|c|}
\hline
\textbf{Objeto}        & \multicolumn{1}{l|}{\textbf{Conjunto de posibles valores}} \\ \hline
Humedad de Suelo       & \{ 0 - 1024\}                                              \\
Tipo de Suelo          & \{ Arcilloso, Limoso, Arenoso\}                            \\
Probabilidad de lluvia & \{ 0 - 100 \}                                              \\
Riego                  & \{ RiegoArcilloso, RiegoLimoso, RiegoArenoso, NoRegar\}   \\ \hline
\end{tabular}
\end{table}


A partir de estos datos se generaron reglas que determinan cuando realizar un riego.

Para generalizar un poco las reglas del modelo a ha creado una tabla con las valores predefinidos como de ve en el Cuadro \ref{valoresReglas}:

\begin{table}[h]
\centering
\caption{Variables predefinidas para la reglas del modelo}
\label{valoresReglas}
\begin{tabular}{|l|}
\hline
\textbf{Valores}                  \\ \hline
Humedad = H = 700                 \\
Probabilidad de lluvia = P = 70\% \\ \hline
\end{tabular}
\end{table}


Como esto es un prototipo, estos valores se pueden modificar para mejorar la calidad del riego, esto se podría hacer consultando a un experto en al área de riego de suelo y dejarlos fijos sin que  vuelvan a cambiar. Otra opción es utilizar ``elicitation technique''; que es una técnica usada para obtener datos y reunir conocimiento o información desde las personas, por lo que al momento de que el dispositivo es instalado se pueden configurar estas variables, dejando a las personas que tomen la decisión que consideren más apropiada para su jardín, esto también podría ser modificado a través del tiempo para ir ajustándolo gradualmente y obtener el mayor beneficio posible (ahorro de agua v/s césped verde).

Incluso el dispositivo podría aprender ajustando sus valores automáticamente como puede ser el caso de la probabilidad de lluvia. También se puede automatizar la humedad del suelo preguntándole periódicamente al usuario el estado del césped para ajustar el tiempo de riego.

Estas reglas se pueden mejorar y aumentar su complejidad a medida que se agreguen nuevas variables al modelo, utilizando eficientemente el agua sin afectar la calidad del riego, en el Cuadro \ref{reglasModelo} se pueden apreciar las reglas que se definieron para el modelo de riego.


\begin{table}[]
\centering
\caption{Reglas modelo, cuando y como regar}
\label{reglasModelo}
\begin{tabular}{|lll|}
\hline
                       &                                                                                                                                                                                                                                                                                                                                                             &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{\textbf{Regar}}                                                                                                                                                                                                                                                                                                                         &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}If Humedad \textless H and Probabilidad \textless P and Suelo == ``Arcillo'' then RiegoArcilloso,\\ If Humedad \textless H and Probabilidad \textless P and Suelo == ``Limoso'' then RiegoLimoso,\\ If Humedad \textless H and Probabilidad \textless P and Suelo == ``Areno'' then RiegoArenoso\end{tabular}} &  \\ \cline{2-2}
                       &                                                                                                                                                                                                                                                                                                                                                             &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{\textbf{NO regar (Alta probabilidad de lluvia)}}                                                                                                                                                                                                                                                                                        &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{If Humedad \textless H and Probabilidad \textgreater P then No regar}                                                                                                                                                                                                                                                                   &  \\ \cline{2-2}
                       &                                                                                                                                                                                                                                                                                                                                                             &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{\textbf{NO regar (Humedad de suelo suficiente)}}                                                                                                                                                                                                                                                                                        &  \\ \cline{2-2}
\multicolumn{1}{|l|}{} & \multicolumn{1}{l|}{If Humedad \textgreater H then No regar}                                                                                                                                                                                                                                                                                                &  \\ \cline{2-2}
                       &                                                                                                                                                                                                                                                                                                                                                             &  \\ \hline
\end{tabular}
\end{table}

Gráficamente estas reglas se pueden ver como árbol tal como lo muestra la Figura \ref{arbol}, además queda claro que nunca se dará el caso en el que pueda haber como resultado dos tipos de riego diferentes, esto se debe a que el espacio de soluciones existentes es finito. El código fuente del modelo de riego se puede encontrar en el Anexo 1.

\begin{figure}[h]
\centering
\includegraphics[width=13cm]{arbol.png}
\caption{Árbol reglas modelo de riego}
\label{arbol}
\end{figure}

\subsection{Servicio web de suelo}

Para determinar el tipo de suelo en el que el dispositivo se encuentra, se creo un servicio web que dado las coordenadas geográficas entregará la información requerida.

El servicio consta de dos partes:

\begin{itemize}
\item El dispositivo determina el tipo de suelo y lo almacena en la base de datos.
\item El dispositivo consulta el tipo de suelo para ser utilizado en el modelo der riego.
\end{itemize}

\subsubsection{Determinando tipo suelo}
Para determinar el tipo de suelo y guardarlo en la base de datos se utilizan dos programas, uno en Python y un servicio web en PHP.

El programa en Python se ejecuta en la Raspberry Pi y utilizando el GPS obtiene las coordenadas geográficas, se puede ver en el Anexo X. Cuando se tienen las coordenadas se llama al servicio web para que este lo guarde.

El servicio web solo recibe como parámetros las coordenadas, es éste quien con la información recibida determina el tipo de suelo y recién es cuando se guarda la información en la base de datos.

El código utilizado se ve en el Listing \ref{detectarSuelo}:

\lstset{language=PHP, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Servicio web que almacena el tipo de suelo},label=detectarSuelo]
id = $_POST["id"];
$lat = $_POST["lat"];
$lon = $_POST["lon"];
$selectSuelo = "SELECT domsoi FROM dsmw WHERE st_contains(geom,ST_GeomFromText('POINT(".$lon." ".$lat.")',4326))";
$result = pg_query($dbconn3, $selectSuelo);
$row = pg_fetch_row($result);
$suelo = $row[0];
$insert = "INSERT INTO coordenadas(id, lat, lon, suelo) VALUES('".$id."', '".$lat."', '".$lon."', '".$suelo."')";
$result = pg_query($dbconn3, $insert);
\end{lstlisting}


Luego consulta por el tipo de suelo a una base de datos espacial\footnote{http://data.fao.org/map?entryId=446ed430-8383-11db-b9b2-000d939bc5d8} con la siguiente consulta SQL que se muestra en el Listing \ref{obtenerSuelo}:

\lstset{language=SQL, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Servicio web que obtiene el tipo de suelo},label=obtenerSuelo]
SELECT domsoi FROM dsmw WHERE st_contains(geom,ST_GeomFromText('POINT(".$lon." ".$lat.")',4326))
\end{lstlisting}

Finalmente inserta un id (de la Raspberry Pi), las coordenadas y el tipo de suelo a la base de datos. El resultado queda como en la Figura \ref{resultadoSuelo1}

\begin{figure}[h]
\centering
\includegraphics[width=13cm]{resultadoSuelo.png}
\caption{Registro almacenado en la base de datos}
\label{resultadoSuelo1}
\end{figure}

\subsubsection{Consultando tipo suelo}
Cuando el modelo de riego necesita saber el tipo de suelo, consulta por el registro que se mostró anteriormente, esto se hace desde la Raspberry Pi.

El código en Python que lo haces es el que se en el Listing \ref{obtenerSueloRaspberry}:

\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Obtener el tipo de suelo desde la Raspberry Pi},label=obtenerSueloRaspberry]
serial = getserial()
url = "http://bri2.utalca.cl/~nmaturana/getCoordenada.php?id="+serial
response = urllib.urlopen(url)
data = json.loads(response.read())
suelo = data["suelo"]
\end{lstlisting}

El servicio en PHP recibe como paramento el id del dispositivo y retorna el tipo de suelo se puede apreciar en el Listing \ref{obtenerSueloPHP}:

\lstset{language=PHP, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Servicio web que retorna el tipo de suelo},label=obtenerSueloPHP]
$id = $_GET["id"];
$result = pg_query($dbconn, "Select suelo from coordenadas where id = '".$id."'");
$arr = pg_fetch_array($result, NULL, PGSQL_ASSOC);
echo json_encode($arr);
\end{lstlisting}

\subsection{Envío y consulta de datos, humedad y agua utilizada}

\subsubsection{Envío de datos}

El envío de datos se hace en la Raspberry Pi la que a su vez llama a un servicio web que almacena los datos en la base de datos.

Los datos son enviados cada 30 segundos, como lo muestra en el Listing \ref{enviodedatos}:

\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={Envío de datos desde la Raspberry Pi hacia el servidor},label=enviodedatos]
while True:
	fecha = datetime.datetime.now()
	entradas = arduino.readline()
	datos = entradas.split(" ")
	humedad = datos[0]
	caudal = datos[1]
	mydata=[('humedad',humedad),('caudal',caudal),('fecha',fecha)]
	mydata=urllib.urlencode(mydata)
	path='http://bri2.utalca.cl/~nmaturana/insertData.php'
	req=urllib2.Request(path, mydata)
	req.add_header("Content-type", "application/x-www-form-urlencoded")
	page=urllib2.urlopen(req).read()
	time.sleep(30)
\end{lstlisting}

La humedad y cantidad de agua utilizada se leen desde el Arduino y son pasadas al servicio web ``insertData.php'' que basicamente inserta la información recibida en la base de datos como se ve en la Listing \ref{insertPHP}:

\lstset{language=PHP, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={insertData.php},label=insertPHP]
$humedad = $_POST["humedad"];
$caudal = $_POST["caudal"];
$fecha = $_POST["fecha"];
$insert = "INSERT INTO registros(humedad, caudal, fecha) VALUES('".$humedad."', '".$caudal."', '".$fecha."')";
$result = pg_query($dbconn3, $insert);
\end{lstlisting}

Y el resultado de todo este proceso se ve en la Figura \ref{registros}. La primera columna corresponde a la humedad, la segunda a la cantidad de agua utilizada y la tercera es la fecha.

\begin{figure}[h]
\centering
\includegraphics[width=7cm]{registros.png}
\caption{Registros almacenados en la base de datos}
\label{registros}
\end{figure}

\subsubsection{Consulta de datos}

Estos datos son consultados por la aplicación web que utilizando JQUERY obtiene los datos. El Listing \ref{humedadPHP} obtiene los datos de humedad del suelo y los almacena en dps para luego mostrar esta información a los usuarios.

\lstset{language=JAVA, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={JQuery humedad de suelo},label=humedadPHP]
$.getJSON("http://bri2.utalca.cl/~nmaturana/getRegistros.php", function (result) {
	yVal = parseInt(result["humedad"]);
 	dps.push({ x: xVal, y: yVal });
 	xVal++;
});
\end{lstlisting}

El servicio web ``getRegistros.php'' retorna el ultimo registro insertado en la base de datos como se muestra en el Listing \ref{getRegistros}:

\lstset{language=PHP, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={getRegistros.php},label=getRegistros]
$result = pg_query($dbconn, "SELECT * FROM registros ORDER BY fecha DESC LIMIT 1");
$arr = pg_fetch_array($result, NULL, PGSQL_ASSOC);
echo json_encode($arr);
\end{lstlisting}



\subsection{Aplicación web}

La aplicación web que básicamente muestra la humedad actual del suelo y el consumo de agua mensual fue desarrollada utilizando PHP, HTML y JAVASCRIPT.\\

La Figura \ref{resultadoSueloGrafico1} muestra la humedad registrada por el sensor de humedad y además indica la hora en el que el registro fue capturado.

\begin{figure}[h]
\centering
\includegraphics[width=13cm]{graficoHumedad.png}
\caption{Humedad del suelo en tiempo real}
\label{resultadoSueloGrafico1}
\end{figure}

\pagebreak

La Figura \ref{resultadoSueloGrafico2} muestra el consumo de agua durante los últimos seis meses como se muestra en la boleta de consumo de agua potable que llega nuestro hogar.

\begin{figure}[h]
\centering
\includegraphics[width=13cm]{graficoAgua.png}
\caption{Consumo de agua mensual}
\label{resultadoSueloGrafico2}
\end{figure}

\chapter{Pruebas}

El prototipo no se pudo probar directamente funcionando en un jardín, pero si se probaron los componentes que entregan la mayor parte de las funcionalidades y que algunas son las entradas para el modelo de riego, por lo que su correcto funcionamiento es fundamental.
Si el dispositivo utiliza demasiada o muy poca agua en el riego significa que hay que ajustar el modelo que determina cuando y como regar.

\section{Sensor de caudal}

Las pruebas que se realizaron con el sensor de caudal se hicieron utilizando distintos caudales y cantidades de agua.

Los pasos utilizados para las pruebas fueron los siguientes:

\begin{itemize}
\item Se lleno un recipiente de agua.
\item El caudal recibido desde el sensor fue guardado en la base de datos junto con la hora.
\item Se calculó el promedio del caudal almacenado en la base de datos.
\item Se calculó el tiempo en minutos desde que comenzó hasta que terminó el envío de datos.
\item Finalmente utilizando regla de tres simple de calculó la cantidad de agua que paso a través del sensor.

\item AguaUtilizada = $\frac{TiempoEnMinutos \times CaudalPromedio}{60}$
\end{itemize}

Prueba de 1.5 Litros de agua:
\begin{itemize}
\item CaudalPromedio = 347
\item TiempoEnMinutos = 0.25
\item AguaUtilizada = $\frac{0.25 \times 347}{60}$ = 1.45 Litros
\end{itemize}

Prueba de 1.5 Litros de agua, caudal diferente:
\begin{itemize}
\item CaudalPromedio = 87
\item TiempoEnMinutos = 1
\item AguaUtilizada = $\frac{1 \times 87}{60}$ = 1.45 Litros
\end{itemize}

Prueba de 10 Litros de agua:
\begin{itemize}
\item CaudalPromedio = 646
\item TiempoEnMinutos = 0.93
\item AguaUtilizada = $\frac{0.93 \times 646}{60}$ = 10.04 Litros
\end{itemize}

Prueba de 10 Litros de agua, caudal diferente:
\begin{itemize}
\item CaudalPromedio = 320
\item TiempoEnMinutos = 1.87
\item AguaUtilizada = $\frac{1.87 \times 320}{60}$ = 10.01 Litros
\end{itemize}

Rango de error del sensor +/- 3\%\footnote{http://www.olimex.cl/pdf/Sensors/water\%20flow\%20sensor\%20datasheet.pdf}.

\section{Sensor de humedad}

Las pruebas que se realizaron con el sensor de humedad se hicieron utilizando dos macetas con tierra, una tenia tierra totalmente seca, otra tierra totalmente mojada.
Según indica la documentación del sensor de humedad los rangos de humedad son los siguientes\footnote{https://www.dfrobot.com/wiki/index.php?title=Moisture\_Sensor\_(SKU:SEN0114)}:

\begin{itemize}
\item 0 - 300 : in water (mojada)
\item 300 - 700 : humid soil (húmeda)
\item 700 - 1024 : dry soil (seca)
\end{itemize}

Los pasos utilizados para las pruebas fueron los siguientes:

\begin{itemize}
\item Se llenó una maceta con tierra seca.
\item Se llenó una maceta con tierra mojada.
\item Se midió la humedad de la maceta con tierra.
\item La humedad recibida desde el sensor fue guardada en la base de datos junto con la hora.
\end{itemize}

Prueba tierra seca:
\begin{itemize}
\item Humedad de Suelo = 1023
\end{itemize}

Prueba tierra mojada:
\begin{itemize}
\item Humedad de Suelo = 31
\end{itemize}

Rango de error del sensor +/- 5\%\footnote{https://www.dfrobot.com/wiki/index.php?title=Moisture\_Sensor\_(SKU:SEN0114)}.

\section{Detección de suelo}

Para las pruebas de detección de suelo se tomaron 3 coordenadas al azar de la región del Maule. Con estas coordenadas se consulto el tipo de suelo utilizando el servicio web creado para este propósito y se comparo contra el resultado obtenido al utilizar la herramienta QGis que permite visualizar directamente los datos.

En la Figura \ref{mapasuelo} se muestran los puntos en los que se consultó por el tipo de suelo, además el mapa muestra el tipo de suelo en los que se encuentran.

\begin{figure}[h]
\centering
\includegraphics[width=13cm]{mapasuelo.png}
\caption{Mapa de suelo}
\label{mapasuelo}
\end{figure}

\pagebreak

Coordenada -71.419,-35.158:
\begin{figure}[h]
\centering
\includegraphics[width=13cm]{suelo1.png}
\caption{Resultado consulta Suelo 1}
\label{mapasuelo1}
\end{figure}

Coordenada -72.141,-35.287:
\begin{figure}[h]
\centering
\includegraphics[width=13cm]{suelo2.png}
\caption{Resultado consulta Suelo 2}
\label{mapasuelo2}
\end{figure}

\pagebreak

Coordenada -71.232,-34.965:
\begin{figure}[h]
\centering
\includegraphics[width=13cm]{suelo3.png}
\caption{Resultado consulta Suelo 3}
\label{mapasuelo3}
\end{figure}

Como se puede apreciar, cada coordenada que fue consultada al servicio web coincide con la información que se tiene en QGis.

Como solo se trabaja con tres tipos de suelos, la conversión se hace utilizando una clasificación de suelo\footnote{http://cals.arizona.edu/oals/soils/fao.html}.

\section{Pronóstico del clima}
Para verificar que la información obtenida desde el servicio web que entrega la probabilidad de lluvia, se consulto el clima directamente desde la interfaz de wunderground y luego se realizó una consulta al mismo lugar utilizando el servicio web creado, los resultados fueron los siguientes:
\\
\\
Prueba 1:
\begin{itemize}
\item Lugar: Punta Arenas.
\item Resultado wunderground:
	\begin{figure}[h]
	\centering
	\includegraphics[width=7cm]{puntaarenas1.png}
	\caption{Clima Punta Arenas wunderground}
	\label{puntaarenas1}
	\end{figure}

\pagebreak

\item Resultado servicio web:
	\begin{figure}[h]
	\centering
	\includegraphics[width=13cm]{puntaarenas.png}
	\caption{Clima Punta Arenas servicio web}
	\label{puntaarenas1}
	\end{figure}
\end{itemize}


Prueba 2:
\begin{itemize}
\item Lugar: Corcolén.
\item Resultado wunderground:
	\begin{figure}[h]
	\centering
	\includegraphics[width=7cm]{corcolen.png}
	\caption{Clima Corcolén wunderground}
	\label{puntaarenas1}
	\end{figure}

\item Resultado servicio web:
	\begin{figure}[h]
	\centering
	\includegraphics[width=13cm]{corcolen1.png}
	\caption{Clima Corcolén servicio web}
	\label{puntaarenas1}
	\end{figure}
\end{itemize}

\chapter{Conclusión}

Se puede concluir que el desarrollo de este dispositivo puede generar un beneficio económico para las personas y a la vez ayudar a combatir el cambio climático que hoy nos afecta, al ser un dispositivo de bajo costo puede ser adquirido masivamente.

El dispositivo no fue probado funcionando directamente en un jardín, por lo que no se puede afirmar que realmente se esta utilizando menos al momento de realizar un riego, pero como se esta consiente de la probabilidad de lluvia al momento de regar, es aquí donde se esta haciendo un ahorro de agua y esto se hace automática e inteligentemente.

Tampoco se puede afirmar que el detectar un tipo de suelo y aplicarle un determinado riego reduzca la cantidad de agua utilizada sin afectar la calidad del césped. Para esto se necesita hacer pruebas de campo que permitan asegurar que el tipo de suelo afecta en la cantidad de agua utilizada.

El hardware que se utilizó se podría reemplazar, disminuyendo la cantidad de componentes que se utilizaron y mejorando la eficiencia. Existe un microcomputador llamado ``beaglebone black''\footnote{http://beagleboard.org/BLACK} que podría reemplazar a la Raspberry Pi y el Arduino. En cuanto a los sensores no se puede afirmar nada acerca de su funcionamiento, ya que no fueron probados en condiciones de uso reales, pero durante las pruebas tuvieron un correcto funcionamiento.

Los dispositivos que se venden en la actualidad tienen un costo muy elevado o requieren de mucha intervención de personas, por lo que muchas veces se dejan de utilizar o no se utiliza correctamente.

Este dispositivo se puede ampliar al uso agrícola, uno de los grandes problemas identificados por el Gobierno es la falta de tecnología aplicada en la agricultura. Este dispositivo puede ser fácilmente utilizado para este fin, sin duda que se le pueden agregar más sensores y mejorar el modelo para cada tipo de cultivo.

En el desarrollo del modelo de riego que determina cuándo y cómo regar se debería trabajar con un especialista en el área, Smart Irrigation es muy flexible en este sentido y es uno de los puntos a mejorar.

Este trabajo aparte de la investigación, escritura del documento y desarrollo de un prototipo del dispositivo de riego también incluyó trabajo externo en un concurso de emprendimiento llevado a cabo por Fundación para la Innovación Agraria, el concurso llamado ``Proyectos de Emprendimiento Innovador: Jóvenes Innovadores''. En este concurso el dispositivo fue uno de los finalistas, los participantes tuvieron una capacitación en Santiago durante dos semanas con profesores de la Universidad de Oxford, en esas dos semana se vio principalmente gestión y financiamiento de proyectos. En el Anexo \ref{aped.fia} se puede ver parte del trabajo realizado durante este período.

Queda claro que es una idea muy viable, ya que en la actualidad existe un problema que no esta solucionado, el cual es el uso ineficiente del agua utilizada en el riego y la automatización de este proceso.
Es relevante mencionar que existe un mercado potencial para hacer económicamente sustentable esta idea y que con su utilización se puede ayudar considerablemente al cuidado del agua y el medio ambiente.


\chapter{Trabajo futuro}


Esta idea tiene un gran potencial y sin duda quedan muchas cosas por mejorar.

En el modelo de riego se recomienda trabajar junto a un experto en el área de riego, además para hacer el dispositivo más inteligente sería ideal que se aplicara una técnica de inteligencia artificial y que fuera aprendiendo variables de humedad, probabilidad de lluvia y entre otras que se debieran utilizar. El diseño del dispositivo se hizo de tal manera que se pueda ingresar un nuevo modelo de riego y que este funcione correctamente, por lo que se puede profundizar mucho más el tema y mejorar el funcionamiento del dispositivo en general.

Este trabajo de enfoco principalmente en el diseño del prototipo del dispositivo y el modelo de riego, el desarrollo de la aplicación para el usuario no fue la mejor, solamente se muestran dos gráficos que les entrega información, se le podría agregar más funciones para que el usuario interactué con el dispositivo.

Hay que mejorar el diseño de la base de datos, para que solo se guarde información que le sirva a la aplicación y no guardar registros que no son significativos.

También quedo pendiente el desarrollo de una aplicación móvil para los usuarios, lo que haría mucho más interésate el uso del dispositivo.

Finalmente falta realizar pruebas de campo que permitan validar los reales beneficios que ofrece el dispositivo.

%% ambiente glosario
\begin{glosario}
  \item[QGis:]  Sistema de Información Geográfica (SIG) de código libre para plataformas GNU/Linux, Unix, Mac OS, Microsoft Windows y Android.
  \item[GPS:] es un sistema que permite determinar en todo el mundo la posición de un objeto (una persona, un vehículo).
\end{glosario}

%% genera las referencias
\bibliography{refs}


%% comienzo de la parte de anexos
\appendixpart

%% contenido del primer anexo
\appendix{Trabajo realizado en FIA}\label{aped.fia}
\begin{figure}[h]
\centering
\includegraphics[width=10cm]{outside.png}
\caption{Exterior tríptico realizado en FIA}
\label{outside}
\end{figure}

\pagebreak

\begin{figure}[h]
\centering
\includegraphics[width=10cm]{inside.png}
\caption{Interior tríptico realizado en FIA}
\label{inside}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=15cm]{smartirrigation.jpg}
\caption{Resumen ejecutivo}
\label{inside}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=15cm]{0001.jpg}
\caption{Presentación parte 1}
\label{inside}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=15cm]{0002.jpg}
\caption{Presentación parte 2}
\label{inside}
\end{figure}

%% contenido del segundo anexo
\appendix{Código fuente}
\section{gps.py}
\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={gps.py},label=gpspy]
#! /usr/bin/python
# Written by Dan Mandle http://dan.mandle.me September 2012
# License: GPL 2.0
import os
from gps import *
from time import *
from id import getserial
import time
import threading
import sys
import urllib2, urllib

gpsd = None #seting the global variable
os.system('clear') #clear the terminal (optional)

class GpsPoller(threading.Thread):
  def __init__(self):
    threading.Thread.__init__(self)
    global gpsd #bring it in scope
    gpsd = gps(mode=WATCH_ENABLE) #starting the stream of info
    self.current_value = None
    self.running = True #setting the thread running to true

  def run(self):
    global gpsd
    while gpsp.running:
      gpsd.next() #this will continue to loop and grab EACH set of gpsd info to clear the buffer

if __name__ == '__main__':
  gpsp = GpsPoller() # create the thread
  try:
    gpsp.start() # start it up
    while True:
      #It may take a second or two to get good data
      #print gpsd.fix.latitude,', ',gpsd.fix.longitude,'  Time: ',gpsd.utc
      os.system('clear')
      if gpsd.fix.latitude != 0.0 and  not (math.isnan(gpsd.fix.latitude)):
        mydata=[('id',getserial()),('lat',gpsd.fix.latitude),('lon',gpsd.fix.longitude)]
        mydata=urllib.urlencode(mydata)
        path='http://bri2.utalca.cl/~nmaturana/insertCoor.php'
        req=urllib2.Request(path, mydata)
        req.add_header("Content-type", "application/x-www-form-urlencoded")
        page=urllib2.urlopen(req).read()
        print page
        gpsd.running = False
        sys.exit(0)
      time.sleep(5) #set to whatever
  except (KeyboardInterrupt, SystemExit): #when you press ctrl+c
    print "\nKilling Thread..."
    gpsp.running = False
    gpsp.join() # wait for the thread to finish what it's doing
  print "Done.\nExiting."
\end{lstlisting}

\pagebreak

\section{riego.py}
\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={riego.py},label=riegopy]
#! /usr/bin/python
import datetime
import time
from id import getserial
from clima import lluvia
from serial import Serial
import RPi.GPIO as GPIO
import urllib, json

#BCM -> maneja los pines por los numeros de GPIO17
#BOARD -> maneja los pines por numero de secuencia 1, 2, 3...
GPIO.setmode(GPIO.BCM)
GPIO.cleanup()
GPIO.setwarnings(False)
GPIO.setup(27,GPIO.OUT)

#probabilidad de lluvia
#lluvia(latitud,longitud)

#obtener serial
#getserial()

serial = getserial()
url = "http://bri2.utalca.cl/~nmaturana/getCoordenada.php?id="+serial
response = urllib.urlopen(url)
data = json.loads(response.read())
suelo = data["suelo"]

arduino = Serial('/dev/ttyUSB0', 9600, timeout=1)

while True:
	hora = datetime.datetime.now().time()
	#Se prende desde las 6 a.m hasta las 23.59 p.m
	if (hora >= datetime.time(6,00) and hora <= datetime.time(6,20)):
		entradas = arduino.readline()
		datos = entradas.split(" ")
		if len(datos) == 2:
			humedad = datos[0]
			if humedad < 700:
				if suelo == "arena":
					#Reigo arenoso
					GPIO.output(17,GPIO.HIGH)
					time.sleep(1200)#Riego por 20 min
				else if suelo == "limoso":
					#Riego limoso
					GPIO.output(17,GPIO.HIGH)
					time.sleep(1200)#Riego por 20 min
				else:
					#Riego Arcilloso
					GPIO.output(17,GPIO.HIGH)
					time.sleep(1200)#Riego por 20 min
	else:
		GPIO.output(17,GPIO.LOW)
	time.sleep(60)
\end{lstlisting}

\pagebreak

\section{clima.py}
\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={clima.py},label=climapy]
#! /usr/bin/python
import urllib2
import json
import time

#f = urllib2.urlopen('http://api.wunderground.com/api/e7d949410a7481dc/forecast10day/lang:SP$
#json_string = f.read()
#parsed_json = json.loads(json_string)

def lluvia(lat, lon):
        f = urllib2.urlopen('http://api.wunderground.com/api/e7d949410a7481dc/forecast10day/lang:SP/q/'+ str(lat) +','+ str(lon)  +'.json')
        json_string = f.read()
        parsed_json = json.loads(json_string)
        location = parsed_json['forecast']['txt_forecast']['forecastday'][0]['title']
        temp_c = parsed_json['forecast']['txt_forecast']['forecastday'][0]['fcttext_metric']
        pop = parsed_json['forecast']['txt_forecast']['forecastday'][0]['pop']
        f.close()
        return pop
\end{lstlisting}

\pagebreak

\section{servicio.py}
\lstset{language=PYTHON, breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single,caption={servicio.py},label=arduinopy]
#! /usr/bin/python
import urllib2, urllib
from serial import Serial
import datetime
import time
import Queue
from threading import Thread

q=Queue.Queue()

def enviarBD():
	while True:
		mydata = q.get()
		mydata = urllib.urlencode(mydata)
		path = 'http://bri2.utalca.cl/~nmaturana/insertData.php'
		req = urllib2.Request(path, mydata)
		req.add_header("Content-type", "application/x-www-form-urlencoded")
		page = urllib2.urlopen(req).read()
		print page

arduino = Serial('/dev/ttyUSB0', 9600, timeout=1)

t = Thread(target=enviarBD)
t.daemon=True
t.start()

while True:
	fecha = datetime.datetime.now()
	entradas = arduino.readline()
	datos = entradas.split(" ")
	if len(datos) == 2:
		humedad = datos[0]
		caudal = datos[1]
		mydata=[('humedad',humedad),('caudal',caudal),('fecha',fecha)]
		q.put(mydata)


\end{lstlisting}

%% fin
\end{document}

   

